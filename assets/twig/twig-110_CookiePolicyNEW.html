<script>
if(typeof lang === 'undefined') var lang = 'en';
var variation_lang = '{{ landing.Lang }}';

// if(typeof cGetCookie === 'undefined') {
  const cGetCookie = (name) => {
    const nameEq = `${name}=`;
    const cookies = document.cookie.split(';');

    for (const cookie of cookies) {
      const trimmedCookie = cookie.trim();
      if (trimmedCookie.startsWith(nameEq)) return decodeURIComponent(trimmedCookie.substring(name.length + 1));
    }
  };
// }
</script>

<style>
:root {
  --overlay-bg-color: rgba(0,0,0,.8);

  --modal-bg-color: #ffffff;
  --modal-box-shadow: 3px 3px 10px rgba(0,0,0,.2);
  --modal-title-color: #7f6c9d;
  --modal-txt-color: #808080;
  --modal-border-radius: 10px;

  --btn-border-radius: 7px;
  --btn-text-color: #ffffff;
  --btn-bg-color: #2ed283;
  --btn-border-color: #2ed283;
  --btn-bg-hover: #36e08b;
  --btn-border-color-hover: #36e08b;

  --btn-pref-text-color: #808080;
  --btn-pref-bg-color: #ffffff;
  --btn-pref-border-color: #808080;
  --btn-pref-text-color-hover: #ffffff;
  --btn-pref-bg-hover: #808080;
  --btn-pref-border-color-hover: #808080;

  --link-color: #23a0c6;

  --modal-close-size: 20px;
  --modal-close-color: #ccc;
  --modal-close-thickness: 2px;
  --badge-color: #e6e6e6;
}
div.hidden {
  display: none;
}
div.cookies_policy_banner {
  line-height: 1.2;
}

div.cookies_policy_banner.cookies_detail_open{
  position: fixed;
  top: 0;
  left: 0;
  z-index: 11000;
  padding: 2em;
  display: flex !important;
  align-items: flex-start;
  justify-content: center;
  box-sizing: border-box;
  width: 100%;
  height: 100%;
  overflow-x: auto;
  background-color: var(--overlay-bg-color);
}

/* MODAL  */
div.cookies_modal > div,
div.cookies-dialog-policy{
  padding:2em;
  box-sizing: border-box;
  position: relative;
  font-size: 13px;
  margin: 0 auto;

  background-color: var(--modal-bg-color);
  box-shadow: var(--modal-box-shadow);
  border-radius: var(--modal-border-radius);
  color: var(--modal-txt-color);
}

div.cookies-dialog-detail,
div.cookies-dialog-policy-content {
  font-size: 14px;
}

div.cookies-dialog-detail > h4,
div.cookies-dialog-policy-content > h2 {
  text-transform: uppercase;
  margin: 0 0 20px;
  font-size: 21px;

}
div.cookies-dialog-policy-content > h2 {
  margin-top: 10px;
}

div.cookies-dialog-close {
  position: absolute;
  top: 15px;
  right: 15px;
  cursor: pointer;
  background-color: #fff;

  width: var(--modal-close-size);
  height: var(--modal-close-size);
}

div.cookies-dialog-close:before,
div.cookies-dialog-close:after {
  content: '';
  position: absolute;
  left: 0;
  right: 0;

  top: calc((var(--modal-close-size) - var(--modal-close-thickness)) / 2);
  height: var(--modal-close-thickness);
  background: var(--modal-close-color);
  border-radius: var(--modal-close-thickness);
}

div.cookies-dialog-close:before {
  transform: rotate(45deg);
}

div.cookies-dialog-close:after {
  transform: rotate(-45deg);
}

/* DIALOG MAIN */
div.cookies-dialog-main{
  position: fixed !important;
  z-index: 11000;
  top: 1em;
  bottom: initial;
  left: 50%;
  width: 100%;
  max-width: 315px;
  transform: translatex(-50%);
  font-size: 12px;
}

div.cookies-dialog-main > span {
  display: block;
  margin: 0 0 1em;
  line-height: 1.2em;
}

div.cookies-dialog-main > h4 {
  display: none;
}

.cookies_policy_minimized{
  display: flex;
  width: 45px;
  height: 45px;
  align-items: center;
  justify-content: center;
  background-color: #fff;
  border-radius: 100px;
  transform: scale(.8);

  box-shadow: var(--modal-box-shadow);
}

.cookies_policy_minimized a{
  margin: 15px auto 0;
}

/* POLICY */
div.cookies_policy_banner a {
  text-decoration: underline;

  color: var(--link-color);
}

div.cookies_policy_banner label {
  margin: 1.5em 0 .8em;
  font-size: 1.1em;
  font-weight: 700;
  text-transform:none;
  letter-spacing: 0;
}

div.cookies_policy_banner label input{
  position: static;
  opacity: 1;
  z-index: 0;
  margin: 0;
}

div.cookies_policy_banner label span{
  padding-left: 10px;
}

div.cookies-dialog-policy ul {
  margin: 20px 0;
  padding-left: 20px;
}

div.cookies-dialog-policy ul li {
  margin: 0 0 10px;
}

div.cookies-dialog-policy ul li > ul{
  padding-left: 15px;
}

div.cookies-dialog-policy p+ul {
  margin-top:5px;
}

div.cookies-dialog-policy b{
  font-weight: 700;
}

div.cookies-dialog-policy p b{
  display: block;
  margin: 20px 0 10px;
  font-size: 1.1em;
}

.cookies-dialog-policy-content{
  max-height: 80vh;
  overflow-y: auto;
}

/* BUTTONS  */
div.cookies_policy_banner button,
.cookies_policy_btn {
  all: unset;
  display: inline-block;
  padding: .4em .8em;
  text-align: center;
  cursor: pointer;
  white-space: nowrap;
  font-size: 14px !important;

  transition: all .2s ease-in-out;

  border-radius: var(--btn-border-radius);
  background-color: var(--btn-bg-color);
  border: 1px solid var(--btn-border-color);
  color: var(--btn-text-color);
}

div.cookies_policy_banner button:hover,
.cookies_policy_btn:hover{
  background-color: var(--btn-bg-hover);
  border-color: var(--btn-border-color-hover);
}

div.cookies_policy_banner button.cookies-dialog-switch {
  background-color: var(--btn-pref-bg-color);
  color: var(--btn-pref-text-color);
  border: 1px solid var(--btn-pref-border-color) !important;
}

div.cookies_policy_banner button.cookies-dialog-switch:hover {
  background-color: var(--btn-pref-bg-hover);
  color: var(--btn-pref-text-color-hover);
  border: 1px solid var(--btn-pref-border-color-hover) !important;
}

.cookies-dialog-detail .cookies-dialog-accept-detail{
  margin-top: 30px;
  font-size: 1em;
}

/* SHIELD */
/* Shield based on https://css.gg/shield */
div.cookies_policy_minimized {
  position: fixed;
  left: 1.25em;
  bottom: 1.25em;
  z-index: 1100;
}
div.cookies_policy_minimized a {
  display: block;
  width: 14px;
  height: 18px;
  box-sizing: border-box;
  cursor: pointer;
  transform: scale(1.5);
  border-top: 2px solid var(--modal-txt-color);
  font-size: 0;
}
div.cookies_policy_minimized a:after,
div.cookies_policy_minimized a:before {
  content: '';
  display: block;
  box-sizing: border-box;
  position: absolute;
  top: 0;
  border-radius: 3px;
  width: 8px;
  height: 16px;
  border: 2px solid var(--modal-txt-color);
}
div.cookies_policy_minimized a:before {
  border-bottom-left-radius: 40px;
  border-right: 0;
  left: 0;
}
div.cookies_policy_minimized a:after {
  border-bottom-right-radius: 40px;
  border-left: 0;
  right: 0;
}

/* DIALOG DETAIL */
@media all and (min-width: 769px){

  div.cookies-dialog-detail > h4,
  div.cookies-dialog-policy-content > h2{
    margin-bottom: 30px;
  }

  div.cookies-dialog-close {
    top: 25px;
    right: 25px;
  }

  div.cookies-dialog-main{
    top: auto;
    bottom: 1em;
    left: 1em;
    transform: none;
    font-size: inherit;
  }

  div.cookies-dialog-policy ul {
    padding-left: 2.5em;
  }

  div.cookies_policy_banner.cookies_detail_open{
    overflow: auto;
    overflow-x: hidden;
    align-items: center;
  }

  .cookies-dialog-detail{
    max-width: 70%;
  }

}
</style>

<div class="cookies_policy_banner" style="display: none;"><div class="cookies_modal"></div></div>
<div class="cookies_policy_minimized" style="display: none;"><a>Cookies</a></div>

<script>
function jsonpCall() {
  return new Promise((resolve, reject) => {
    const script = document.createElement('script');
    const callbackName = 'jsonpCallbackfunction';

    function cleanup() {
      delete window[callbackName];
      document.body.removeChild(script);
    }

    window[callbackName] = function (data) {
      cleanup();
      resolve(data);
    };

    script.src = `${gdprUrl}/cookie?callback=${callbackName}`;
    script.async = true;
    script.onerror = function (error) {
      cleanup();
      reject(error);
    };

    document.body.appendChild(script);
  });
}

function setGdprCookie() {
  const expirationDate = new Date();
  expirationDate.setMinutes(expirationDate.getMinutes() + 30);

  if (gdprRecorder) {
    document.cookie = `gdpr_recorder=${gdprRecorder}; expires=${expirationDate.toUTCString()}`;
    gdprRecorder = cGetCookie('gdpr_recorder');
  } else {
    jsonpCall()
      .then(function (data) {
        const uuid = data.uuid;
        document.cookie = `gdpr_recorder=${uuid}:${Date.now()}; expires=${expirationDate.toUTCString()}`;
        gdprRecorder = cGetCookie('gdpr_recorder');
      });
  }
}

function cookies_disclosure_load() {
  var baseUrl = 'https://legal.wemystic.net';
  var endUrl;

  fetch(baseUrl + '/country_lang_map.json')
    .then(function (response) {
      if (response.ok) {
        return response.text();
      } else {
        throw new Error('Failed to fetch country_lang_map.json');
      }
    })
    .then(function (data) {
      var json = JSON.parse(data);
      var use_lang = 'en';
      var available_lang = ['de', 'en', 'es', 'fr', 'it', 'pt'];

      if (json && typeof lang !== 'undefined' && json[lang]) use_lang = json[lang];
      if (variation_lang !== '' && variation_lang !== use_lang && available_lang.includes(variation_lang) === true) use_lang = variation_lang;

      endUrl = baseUrl + '/' + use_lang + '/cookiesdisclosure-new.html';

      return fetch(endUrl);
    })
    .then(function (response) {
      if (response.ok) {
        return response.text();
      } else {
        throw new Error('Failed to fetch cookiesdisclosure-new.html');
      }
    })
    .then(function (data) {
      var cookiesDialogClose = document.createElement('div');
      cookiesDialogClose.className = 'cookies-dialog-close';
      cookiesDialogClose.dataset.anchor = 'cookies-dialog-detail';

      document.querySelector('div.cookies_modal').innerHTML = data;
      document.querySelector('div.cookies-dialog-detail').appendChild(cookiesDialogClose);
      document.querySelector('div.cookies_policy_banner').style.display = 'block';
      document.querySelector('div.cookies_policy_minimized').style.display = 'none';

      // if not the first time, then go to details
      if (!__udeals_cookie_first && typeof(cookies_dialog_open_details) === 'function') {
        cookies_dialog_open_details();
      }
    })
    .catch(function (error) {
      console.error('Error:', error);
    });
}

function sendToKV(hasAcceptedAll) {
  setGdprCookie();
  const today = new Date();
  const options = { day: 'numeric', weekday: 'short', month: 'short', year: 'numeric' };
  const dateTime = today.toLocaleString('default', options);
  const time = today.getHours() + ':' + today.getMinutes() + ':' + today.getSeconds();
  const data = {
    'url': window.location.href,
    'key': gdprRecorder,
    'dateTime': `${dateTime} ${time}`,
    'hasAcceptedAll': hasAcceptedAll
  };

  const url = new URL(`${gdprUrl}/gdpr`);
  url.search = new URLSearchParams(data).toString();

  fetch(url, {
    method: 'GET',
    mode: 'cors',
    headers: {
      'Accept': 'application/json',
      'Access-Control-Allow-Origin': '*'
    }
  })
  .then(response => {
    if (response.ok) {
      return true;
    } else {
      throw new Error('Failed to send data to KV');
    }
  })
  .catch(error => {
    console.error('Error:', error);
    return false;
  });
}

function cookies_dialog_open_details() {
  const current_mode = typeof(cookie_consent_current) === 'function' ? cookie_consent_current() : {};
  current_mode['functional'] = true;

  const inputs = document.querySelectorAll('input.cookie-consent-detail');
  inputs.forEach(function (input) {
    input.checked = current_mode[input.value] ? true : false;
  });

  document.querySelector('.cookies-dialog-main').style.display = 'none';
  document.querySelector('.cookies-dialog-detail').style.display = 'block';
  document.querySelector('.cookies_policy_banner').classList.add('cookies_detail_open');
}

function cookie_consent_update(mode) {
  const udata = {
    'ad_storage': mode['marketing'] ? 'granted' : 'denied',
    'analytics_storage': mode['measurement'] ? 'granted' : 'denied',
    'personalization_storage': mode['functional'] ? 'granted' : 'denied',
  };

  dataLayer.push({ 'event': 'uDealsConsentUpdate' });
}

function cookies_dialog_done(mode) {
  const banner = document.querySelector('div.cookies_policy_banner');
  const minimized = document.querySelector('div.cookies_policy_minimized');
  const modalDivs = document.querySelectorAll('div.cookies_modal > div');

  banner.classList.remove('cookies_detail_open');
  modalDivs.forEach(el => el.style.display = 'none');

  __udeals_cookie_first = false;
  if (mode === undefined || mode === null) mode = __udeals_cookie_consent_full;

  storeCookieConsent(JSON.stringify(mode), null);
  __udeals_cookie_consent_mode = mode;

  cookie_consent_update(mode);
  banner.style.display = 'none';
  minimized.style.display = 'block';
}

function storeCookieConsent(value, exdays) {
  const c_name = 'udeals_cookies_policy';
  let expires = '';

  if (exdays != null) {
    const exdate = new Date();
    exdate.setDate(exdate.getDate() + exdays);
    expires = '; expires=' + exdate.toUTCString();
  }

  const c_value = encodeURIComponent(value) + '; path=/' + expires;
  document.cookie = c_name + '=' + c_value + '; SameSite=Strict';
}

function cookie_consent_current() {
  return __udeals_cookie_consent_mode;
}

function checkAllTrue(udata) {
  return Object.values(udata).every(value => value);
}

var l = window.location;
var gdprUrl = 'https://gdpr-consent-recorder-%s.workers.dev'.replace('%s',(l.origin?.includes('wmstg') ? 'stg.wmstg' : 'prod.wemystic'));
var __udeals_cookie_consent_full = { 'functional': true, 'measurement': true, 'marketing': true };
var __udeals_cookie_consent_mode = __udeals_cookie_consent_full;
var __udeals_cookie_first = true;
var sessionCookie = cGetCookie('udeals_variation_uid');
var gdprRecorder = cGetCookie('gdpr_recorder');
if (!gdprRecorder) { setGdprCookie(); }

document.addEventListener('DOMContentLoaded', function() {
  const cookie_v = cGetCookie('udeals_cookies_policy');
  if (cookie_v) {
    try {
      const v = JSON.parse(cookie_v);
      __udeals_cookie_consent_mode = v;
      __udeals_cookie_first = false;
      document.querySelector('div.cookies_policy_banner').style.display = 'none';
      document.querySelector('div.cookies_policy_minimized').style.display = 'block';
    } catch(e) {
      cookies_disclosure_load();
    }
  } else {
    cookies_disclosure_load();
  }

  document.addEventListener('click', function(event) {
    if (event.target.matches('button.cookies-dialog-switch, button.cookies-dialog-switch span')) {
      cookies_dialog_open_details();
    }
    if (event.target.matches('button.cookies-dialog-accept, button.cookies-dialog-accept span')) {
      if (typeof(cookies_dialog_done) === 'function') cookies_dialog_done(null);
      sendToKV(true);
    }
    if (event.target.matches('button.cookies-dialog-accept-detail, button.cookies-dialog-accept-detail span')) {
      const udata = { 'functional': true, 'measurement': false, 'marketing': false };
      document.querySelectorAll('div.cookies-dialog-detail input.cookie-consent-detail:checked').forEach(function(input) {
        udata[input.value] = true;
      });
      sendToKV(checkAllTrue(udata));
      if (typeof(cookies_dialog_done) === 'function') cookies_dialog_done(udata);
    }
    if (event.target.matches('div.cookies_policy_minimized a')) {
      event.preventDefault();
      document.querySelector('div.cookies_policy_banner').style.display = 'block';
      document.querySelector('div.cookies_policy_minimized').style.display = 'none';
      cookies_disclosure_load();
      return false;
    }
    if (event.target.matches('div.cookies_modal a.external_policy')) {
      event.preventDefault();

      document.querySelectorAll('div.cookies_modal > div').forEach(el => el.style.display = 'none');

      if(document.querySelector('.cookies-dialog-policy')) document.querySelector('.cookies-dialog-policy').remove();

      const policyDiv = document.createElement('div');
      policyDiv.className = 'cookies-dialog-policy';
      policyDiv.style.display = 'none';
      document.querySelector('.cookies_modal').appendChild(policyDiv);

      const policyContentDiv = document.createElement('div');
      policyContentDiv.className = 'cookies-dialog-policy-content';

      const cookiesDialogClose = document.createElement('div');
      cookiesDialogClose.dataset.anchor = 'cookies-dialog-policy';
      cookiesDialogClose.className = 'cookies-dialog-close';

      const url = event.target.href;

      fetch(url)
        .then(response => response.text())
        .then(data => {
          policyContentDiv.innerHTML = data;
          policyDiv.appendChild(policyContentDiv);
          policyDiv.appendChild(cookiesDialogClose);
          policyDiv.style.display = 'block';
        });

      document.querySelector('div.cookies_policy_banner').classList.add('cookies_detail_open');
    }
    if (event.target.matches('.cookies-dialog-close')) {
      event.preventDefault();
      document.querySelectorAll('div.cookies_modal > div').forEach(el => el.style.display = 'none');
      document.querySelector((__udeals_cookie_first ? 'div.cookies-dialog-main' : 'div.cookies_policy_minimized')).style.display = 'block';
      document.querySelector('div.cookies_policy_banner').classList.remove('cookies_detail_open');
    }
  });
});

</script>
